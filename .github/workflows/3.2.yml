name: 3.2 branch Windows snapshot

on:
    push:
        branches:
            - 3.2

    repository_dispatch:
        types: [build_win64_snapshot]

jobs:
    build:
        runs-on: windows-2019

        steps:
            - name: Cache Qt
              id: cache-qt
              uses: actions/cache@v1
              with:
                path: ${{ github.workspace }}\..\Qt
                key: ${{ runner.os }}-Qt-Cache
                
            - name: Install Qt
              uses: jurplel/install-qt-action@v2
              with:
                cached: ${{ steps.cache-qt.outputs.cache-hit }}
                version: '5.14.2'
                host: 'windows'
                arch: 'win64_mingw73'
                dir: '${{ github.workspace }}\..'
                modules: 'qtscript'
                
            - name: Download mingw
              if: steps.cache-qt.outputs.cache-hit != 'true'
              shell: bash
              run: curl -L https://download.qt.io/online/qtsdkrepository/windows_x86/desktop/tools_mingw/qt.tools.win64_mingw730/7.3.0-1x86_64-7.3.0-release-posix-seh-rt_v5-rev0.7z --output ../mingw.7z
              
            - name: Decompress mingw
              if: steps.cache-qt.outputs.cache-hit != 'true'
              run: 7z x -o"${{ github.workspace }}\..\Qt" ..\mingw.7z
 
            - name: Add mingw to PATH
              run: echo "::add-path::${{ github.workspace }}\..\Qt\Tools\mingw730_64\bin"
 
            - name: Clone repo
              uses: actions/checkout@v2
              with:
                ref: 3.2

            - name: Download dependencies
              shell: bash
              run: curl -L https://www.dropbox.com/s/b5t6lb9e7riytq1/win64_deps.zip?dl=1 --output ../win64_deps.zip
            
            - name: Decompress dependencies
              run: 7z x -o".." ..\win64_deps.zip
              
            - name: Add dependencies to PATH
              run: echo "::add-path::${{ github.workspace }}\..\lib"
 
            - name: Prepare output dir
              shell: bash
              run: mkdir output output/build output/build/Plugins
            
            - name: QMake SQLiteStudio3
              working-directory: output/build
              run: qmake.exe DEFINES+=tests ..\..\SQLiteStudio3
            
            - name: Make SQLiteStudio3
              working-directory: output/build
              run: mingw32-make.exe -j 2
            
            - name: QMake Plugins
              working-directory: output/build/Plugins
              run: qmake.exe DEFINES+=tests ..\..\..\Plugins
            
            - name: Make Plugins
              working-directory: output/build/Plugins
              run: mingw32-make.exe -j 2
              
            - name: Tests
              shell: bash
              working-directory: output/SQLiteStudio
              run: for f in `ls tst_*`; do echo $f; done
